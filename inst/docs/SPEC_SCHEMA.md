# SPEC_SCHEMA.md

*Version: 1.0*\
*Last Updated: 2025-11-11*\
*Maintainer: Shushun Ren ([shushun.ren\@lilly.com](mailto:shushun.ren@lilly.com){.email})*

------------------------------------------------------------------------

## 1. Purpose

This document defines the **structure**, **column-level schema**, and **data types** of the standardized Spec Excel file generated by `Program 1` (`generate_spec()`) and consumed by `Program 2` (`run_issue_tracker()`).

The Spec serves as the **central configuration contract** between: - Raw dataset preprocessing (Program 1) - Automated issue tracking and logging (Program 2) - User input through Shiny (study_config.yml → spec)

------------------------------------------------------------------------

## 2. Overview of Spec Structure

Each Spec file is an **Excel workbook** containing multiple standardized sheets.\
All sheets are read-only (auto-generated), except where specified.

| Sheet Name | Description | Editable by User | Generated by |
|----|----|----|----|
| README | Metadata such as study ID, generated time, author | ❌ No | Program 1 |
| SNAPSHOT | Summary of datasets read (rows, columns, status) | ❌ No | Program 1 |
| DATA_INFO | Core mapping of dataset-specific ID and visit variables | ⚙️ Optional via Shiny | Program 1 |
| CHECKPOINTS | List of pre-defined issue checks, parameters, and logic | ⚙️ Parameters editable via Shiny | Program 1 |
| ERRORS | Automatically populated error messages if required parameters missing | ❌ No | Program 1 |
| NOTES | (Optional) User comments or reminders | ✅ Yes | User |

------------------------------------------------------------------------

## 3. Sheet-level Specifications

### 3.1 README Sheet

Stores global metadata of the spec.

| Column | Type | Required | Example | Description |
|----|----|----|----|----|
| study_id | string | ✅ | `I7P_MC_DSAF` | Study identifier |
| generated_at | date | ✅ | `2025-11-11` | Timestamp when the spec was generated |
| generated_by | string | ✅ | `shushunr` | User or program that generated the spec |
| raw_data_path | string | ✅ | `/lillyce/qa/i7p_mc_dsaf/intrm2/` | Path to raw dataset location |
| spec_version | string | ✅ | `1.0.0` | Version of spec schema |
| package_version | string | ✅ | `rchk0_0.2.1` | Version of the R package used |
| yaml_source | string | ❌ | `study_config.yml` | Config source file |
| transfer_id | string | ❌ | `TRF_2025_11_08` | Data transfer identifier (if tracked) |

------------------------------------------------------------------------

### 3.2 SNAPSHOT Sheet

Stores dataset-level summaries from the raw data folder.

| Column | Type | Required | Example | Description |
|----|----|----|----|----|
| dataset | string | ✅ | `ae3001` | Dataset name |
| n_rows | integer | ✅ | `105` | Number of records |
| n_cols | integer | ✅ | `32` | Number of variables |
| dataset_type | string | ✅ | `Raw` or `Derived` | Dataset classification |
| read_success | logical | ✅ | `TRUE` | Whether the dataset was successfully read |
| created_date | date | ❌ | `2025-11-10` | Date the raw dataset was created |
| last_transfer_date | date | ❌ | `2025-11-08` | Date of last transfer |
| remarks | string | ❌ | `Column mismatch vs previous transfer` | Optional message |

------------------------------------------------------------------------

### 3.3 DATA_INFO Sheet

Defines dataset-specific identifiers (used in most checkpoints).

| Column | Type | Required | Example | Description |
|----|----|----|----|----|
| dataset | string | ✅ | `sv1001` | Dataset name |
| subject_id | string | ✅ | `SUBJID` | Subject ID variable name |
| site_id | string | ✅ | `SITE` | Site ID variable name |
| visit_date | string | ⚙️ Optional | `EVENTDT` | Visit date variable name |
| visit_label | string | ⚙️ Optional | `EVENT` | Visit label variable name |
| identifier | string | ❌ | `VISITNUM` | Unique visit identifier (if applicable) |
| include_flag | logical | ✅ | `TRUE` | Whether this dataset participates in issue checks |

------------------------------------------------------------------------

### 3.4 CHECKPOINTS Sheet

Contains the configuration for all automated checks to be performed.\
Each row corresponds to one checkpoint function.

| Column | Type | Required | Example | Description |
|----|----|----|----|----|
| checkpoint_name | string | ✅ | `check_missing_key_vars` | Unique checkpoint identifier |
| function_name | string | ✅ | `compute_missing_key_vars` | R function to execute |
| function_version | string | ✅ | `0.2.1` | Function version from registry |
| datasets_required | string | ⚙️ Optional | `SV, DS6001` | Dataset(s) used by this check |
| required_columns | string | ⚙️ Optional | `SITEID, SUBJECT_ID, VISITNUM` | Variables required to run the check |
| parameters_json | JSON | ⚙️ Optional | `{ "target_vars": ["VISIT", "VISITNUM"] }` | Function parameters (editable via Shiny) |
| enabled | logical | ✅ | `TRUE` | Whether this checkpoint is active |
| severity | string | ⚙️ Optional | `Warning / Critical / Info` | Importance of this check |
| logic_digest | string | ✅ | `Flag rows where VISITNUM is missing` | Plain-text description of check logic |
| logic_hash | string | ✅ | `f83ac9b9` | MD5/SHA hash to detect logic changes |
| notes | string | ❌ | `Auto-generated` | Optional free-text comments |

------------------------------------------------------------------------

### 3.5 ERRORS Sheet

Contains validation errors or missing configurations detected during spec generation.

| Column | Type | Example | Description |
|----|----|----|----|
| dataset | string | `sv1001` | Dataset associated with error |
| checkpoint_name | string | `check_visit_after_ED` | Checkpoint that raised the error |
| message | string | `visit_date not found in data_info` | Error message text |
| severity | string | `Error / Warning` | Type of issue |
| suggestion | string | `Add visit_date column for sv1001` | Recommended fix |

------------------------------------------------------------------------

### 3.6 NOTES Sheet

Optional free-text section for users to record special study-specific logic.

| Column | Type | Example | Description |
|----|----|----|----|
| note_id | string | `N001` | Unique note ID |
| note_text | string | `The LB dataset uses TESTDT instead of VISITDT` | Description of note |
| added_by | string | `shushunr` | User who added the note |
| added_date | date | `2025-11-11` | Timestamp |

------------------------------------------------------------------------

## 4. Versioning & Compatibility Rules

| Component | Version Source | Compatibility Policy |
|----|----|----|
| Spec Schema | `spec_version` in README | Incremented when column definitions change |
| Function Logic | `logic_hash` in CHECKPOINTS | If changed, Shiny will flag as “logic updated” |
| Parameters | `parameters_json` | Users may override but schema must match registered types |

------------------------------------------------------------------------

## 5. Validation Rules

| Rule | Description | Validation Type |
|----|----|----|
| All required columns must be present | Missing column will raise error tab entry | Critical |
| Each dataset in DATA_INFO must exist in SNAPSHOT | Prevents referencing non-existent datasets | Warning |
| logic_hash change triggers warning | Reminds users to re-review logic changes | Warning |
| parameters_json must be valid JSON | Invalid JSON blocks Program 2 | Error |
| Duplicated checkpoint_name disallowed | Enforced by registry | Error |

------------------------------------------------------------------------

## 6. Example Spec File (Preview)

| checkpoint_name | function_name | parameters_json | enabled |
|----|----|----|----|
| check_missing_key_vars | compute_missing_key_vars | `{ "target_vars": ["VISIT","VISITNUM","EVENT"] }` | TRUE |
| check_duplicate_visit_date | compute_duplicate_visit_date | `{ "visit_label_col": "EVENT", "visit_date_col": "EVENTDT" }` | TRUE |

------------------------------------------------------------------------

## 7. Change Log

| Version | Date | Author | Description |
|----|----|----|----|
| 1.0 | 2025-11-11 | Shushun Ren | Initial schema definition for rchk0 Spec file |
| 1.1 | TBD | TBD | Add new sheet for issue history comparison |
